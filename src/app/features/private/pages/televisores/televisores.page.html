<div class="container py-4">
  <!-- Header -->
  <div class="header mb-4">
    <h1 class="mb-2">{{ pageTitle }}</h1>
    <p class="text-muted">{{ pageSubtitle }}</p>
    <div class="d-flex justify-content-end align-items-center">
      <button class="btn btn-primary" (click)="openNewTvModal()">
        <i class="bi bi-plus-circle me-2"></i>
        Nuevo Televisor
      </button>
    </div>
  </div>

  <!-- New TV Modal -->
  <div class="modal fade" id="newTvModal" tabindex="-1" aria-labelledby="newTvModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="newTvModalLabel">Nuevo Televisor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="newTvForm" (ngSubmit)="onSubmitNewTv()">
            <div class="mb-3"><label class="form-label">Nombre</label><input type="text" class="form-control" formControlName="nombre"></div>
            <div class="mb-3" *ngIf="!clienteId"><label class="form-label">Cliente</label>
              <select class="form-select" formControlName="clienteId"><option value="">Seleccionar cliente</option><option *ngFor="let c of clientesDisponibles" [value]="c.id">{{c.nombre}}</option></select>
            </div>
            <div class="mb-3"><label class="form-label">Ubicación</label><input type="text" class="form-control" formControlName="ubicacion"></div>
            <div class="mb-3"><label class="form-label">Resolución</label>
              <select class="form-select" formControlName="resolucion"><option value="1920x1080">1920×1080 (Full HD)</option><option value="3840x2160">3840×2160 (4K)</option></select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" (click)="onSubmitNewTv()" [disabled]="newTvForm.invalid">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TV Cards Grid -->
  <div *ngIf="filteredTvs.length > 0; else emptyState" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <div class="col" *ngFor="let tv of filteredTvs">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title mb-0"><i class="bi bi-tv me-2"></i>{{tv.nombre}}</h5>
          <p class="mb-2 text-muted"><i class="bi bi-geo-alt me-1"></i>{{tv.ubicacion}}</p>
          <div class="mt-auto border-top pt-3 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-images me-1"></i>{{tv.imagenesCount}} imágenes</span>
            <button class="btn btn-outline-primary btn-sm" (click)="openImageModal(tv)">Gestionar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <ng-template #emptyState>
    <div class="text-center py-5"><i class="bi bi-tv display-1 text-muted mb-3"></i><h3>{{emptyStateMessage}}</h3></div>
  </ng-template>

  <!-- Image Management Modal -->
  <div *ngIf="showImageModal" class="image-modal" (click)="closeImageModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Gestión de Imágenes: {{selectedTv?.nombre}}</h3>
        <button class="btn-close" (click)="closeImageModal()"></button>
      </div>
      <div class="modal-body">
        <div class="step-navigation mb-4">
          <button class="btn step-btn" [class.active]="currentModalStep === 'images'" (click)="currentModalStep = 'images'"><i class="bi bi-images me-2"></i>Imágenes</button>
          <button class="btn step-btn" [class.active]="currentModalStep === 'schedule'" [disabled]="!selectedImage"><i class="bi bi-calendar-plus me-2"></i>Programar</button>
        </div>

        <div [ngSwitch]="currentModalStep">
          <!-- Step 1: Images (Table Layout) -->
          <div *ngSwitchCase="'images'">
            <!-- Image Table -->
            <table class="table table-hover image-table" *ngIf="selectedTvImages.length > 0; else noImages">
              <thead>
                <tr>
                  <th scope="col" class="color-legend-cell"></th>
                  <th scope="col">Nombre</th>
                  <th scope="col">Programación</th>
                  <th scope="col">Estado Actual</th> <!-- New Column -->
                  <th scope="col" class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let image of selectedTvImages">
                  <td><div class="color-swatch" [style.background-color]="image.uiColor"></div></td>
                  <td [title]="image.nombre"><img [src]="image.url" class="image-thumbnail me-2"> {{ image.nombre }}</td>
                  <td>
                    <div *ngIf="is24_7(image)" class="badge bg-success">24/7 Activo</div>
                    <div *ngIf="!is24_7(image) && image.horarios.length > 0" class="schedules-list-in-table">
                      <div *ngFor="let h of image.horarios" class="schedule-item-in-table">
                        <span class="schedule-text"><strong>{{getDaysText(h.dias)}}:</strong> {{h.horaInicio}} - {{h.horaFin}}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" (click)="removeSchedule(image, h.id)" title="Eliminar horario">
                          <i class="bi bi-x-lg"></i>
                        </button>
                      </div>
                    </div>
                    <div *ngIf="!is24_7(image) && image.horarios.length === 0" class="badge bg-warning text-dark">Sin programar</div>
                  </td>
                  <td>
                    <span *ngIf="isImageActive(image)" class="badge bg-success">Activa</span>
                    <span *ngIf="!isImageActive(image)" class="badge bg-secondary">Inactiva</span>
                  </td> <!-- New Cell -->
                  <td class="actions-cell text-end">
                    <button class="btn btn-sm btn-outline-primary me-2" (click)="programarImagen(image)" title="Programar">
                      <i class="bi bi-clock"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="deleteImage(image)" title="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #noImages>
              <div class="text-center py-5"><i class="bi bi-image-alt display-1 text-muted"></i><h4 class="mt-3">No hay imágenes</h4></div>
            </ng-template>

            <div class="upload-section mt-4 p-4 border rounded bg-light">
              <div class="drop-zone text-center p-4 border border-dashed rounded"
                   [class.is-drag-over]="isDragOver"
                   (dragover)="onDragOver($event)"
                   (dragleave)="onDragLeave($event)"
                   (drop)="onMultipleDrop($event)">
                <i class="bi bi-cloud-arrow-up display-4 text-muted"></i>
                <p class="mt-3 text-muted">Arrastra y suelta imágenes aquí o haz clic para seleccionar</p>
                <input type="file" multiple accept="image/*" (change)="onMultipleFileSelect($event)" hidden #fileInput>
                <button type="button" class="btn btn-outline-primary" (click)="fileInput.click()">Seleccionar Archivos</button>
              </div>

              <div *ngIf="selectedFiles.length > 0" class="selected-files mt-3">
                <h5>Archivos seleccionados:</h5>
                <ul class="list-group">
                  <li *ngFor="let file of selectedFiles; let i = index" class="list-group-item d-flex justify-content-between align-items-center">
                    {{ file.name }}
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeSelectedFile(i)">
                      <i class="bi bi-x"></i>
                    </button>
                  </li>
                </ul>
                <button type="button" class="btn btn-success mt-3" (click)="uploadMultipleImages()" [disabled]="isUploading">
                  <span *ngIf="isUploading" class="spinner-border spinner-border-sm me-2"></span>
                  Subir Imágenes
                </button>
              </div>
            </div>
          </div>

          <!-- Step 2: Schedule (Timeline Layout) -->
          <div *ngSwitchCase="'schedule'">
            <div class="d-flex align-items-center mb-4">
              <button class="btn btn-outline-secondary me-3" (click)="backToImages()"><i class="bi bi-arrow-left"></i></button>
              <div><h4 class="mb-0">Programar: {{selectedImage?.nombre}}</h4></div>
            </div>

            <form [formGroup]="scheduleForm" (ngSubmit)="addScheduleToImage()">
              <!-- Day Selector -->
              <div class="days-section mb-4">
                <label class="form-label fw-bold">1. Selecciona los días</label>
                <div class="days-grid">
                  <div *ngFor="let day of diasSemana" class="day-checkbox form-check form-check-inline">
                    <input type="checkbox" class="form-check-input" [id]="'day-' + day.value" [checked]="selectedDays.includes(day.value)" (change)="onDayChange(day)">
                    <label class="form-check-label" [for]="'day-' + day.value">{{day.label}}</label>
                  </div>
                </div>
              </div>

              <!-- Schedule Timeline -->
              <div class="time-section mb-3" *ngIf="selectedDays.length > 0">
                <label class="form-label fw-bold">2. Selecciona el rango de horas</label>
                <div class="schedule-timeline">
                  <div class="timeline-slots">
                      <button type="button" *ngFor="let slot of timeSlots" class="time-slot"
                            (click)="onTimeSlotClick(slot)"
                            [disabled]="slot.status === 'occupied'"
                            [ngClass]="{
                              'is-available': slot.status === 'available',
                              'is-selected': slot.status === 'selected'
                            }"
                            [style.background-color]="slot.status === 'occupied' ? slot.color : null"
                            [style.border-color]="slot.status === 'occupied' ? slot.color : null"
                            [title]="slot.status === 'occupied' ? 'Ocupado por: ' + slot.occupiedBy : slot.time">
                      <span *ngIf="slot.status !== 'occupied'">{{slot.time}}</span>
                      <span *ngIf="slot.status === 'occupied'" class="slot-initials">{{ slot.occupiedBy ? slot.occupiedBy.charAt(0) : '' }}</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Resumen y Limpieza -->
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                  <span class="me-2">Inicio: <strong>{{ scheduleForm.value.horaInicio || '--:--' }}</strong></span>
                  <span>Fin: <strong>{{ scheduleForm.value.horaFin || '--:--' }}</strong></span>
                </div>
                <button type="button" class="btn btn-sm btn-link" (click)="clearScheduleSelection()">Limpiar selección</button>
              </div>

              <!-- Action Buttons -->
              <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-secondary me-2" (click)="backToImages()">Cancelar</button>
                <button type="submit" class="btn btn-primary" [disabled]="scheduleForm.invalid || guardandoHorario">
                  <span *ngIf="guardandoHorario" class="spinner-border spinner-border-sm me-2"></span>
                  Guardar Horario
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
